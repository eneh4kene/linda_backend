generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Facility {
  id        String     @id @default(uuid())
  name      String
  phone     String?
  timezone  String     @default("Europe/London")
  settings  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  residents Resident[]
  users     User[]
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  firstName   String
  lastName    String
  role        UserRole  @default(STAFF)
  facilityId  String?
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  facility    Facility? @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([facilityId])
}

model Resident {
  id                       String             @id @default(uuid())
  facilityId               String
  firstName                String
  lastName                 String?
  preferredName            String?
  phoneNumber              String?
  roomNumber               String?
  status                   String             @default("active")
  callConsent              Boolean            @default(false)
  callConsentDate          DateTime?
  lifestoryConsent         Boolean            @default(false)
  lifestoryConsentDate     DateTime?
  preferredCallTimes       Json?
  communicationNotes       String?
  favoriteTopics           String?
  avoidTopics              String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  familyCheckInConsent     Boolean            @default(false)
  familyCheckInConsentDate DateTime?
  // Enhanced scheduling fields (Phase 1)
  targetCallsPerWeek       Int                @default(2)
  minDaysBetweenCalls      Int                @default(2)
  maxDaysBetweenCalls      Int                @default(5)
  callStatus               String             @default("active") // 'active' | 'paused' | 'ended'
  callPauseReason          String?
  callPausedAt             DateTime?
  callPausedUntil          DateTime?
  lastOutboundCallDate     DateTime?
  lastInboundCallDate      DateTime?
  nextSuggestedCallDate    DateTime?
  unavailableUntil         DateTime?
  unavailabilityReason     String?
  calls                    Call[]
  familyCheckIns           FamilyCheckIn[]
  familyMembers            FamilyMember[]
  lifeStoryBook            LifeStoryBook?
  memories                 Memory[]
  facility                 Facility           @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  segments                 StorySegment[]
  callStates               CallState[]
  pattern                  ResidentPattern?
  anticipatedEvents        AnticipatedEvent[]
  callbacks                Callback[]

  @@index([facilityId, status])
  @@index([callStatus, nextSuggestedCallDate])
}

model Call {
  id                String             @id @default(uuid())
  residentId        String
  retellCallId      String?            @unique
  callNumber        Int
  status            String             @default("scheduled")
  isFirstCall       Boolean            @default(false)
  scheduledAt       DateTime?
  startedAt         DateTime?
  endedAt           DateTime?
  durationSeconds   Int?
  audioUrl          String?
  audioDurationMs   Int?
  transcript        Json?
  transcriptText    String?
  summary           String?
  sentimentScore    Float?
  topicsDiscussed   Json?              @default("[]")
  contextUsed       Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  direction         CallDirection      @default(OUTBOUND)
  processed         Boolean            @default(false)
  processedAt       DateTime?
  resident          Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  memories          Memory[]
  segments          StorySegment[]
  callState         CallState?
  anticipatedEvents AnticipatedEvent[]
  callbacks         Callback[]

  @@index([residentId, status])
  @@index([retellCallId])
  @@index([processed])
}

model Memory {
  id               String   @id @default(uuid())
  residentId       String
  sourceCallId     String?
  category         String
  key              String
  value            String
  confidence       Float    @default(0.8)
  timesMentioned   Int      @default(1)
  firstMentionedAt DateTime @default(now())
  lastMentionedAt  DateTime @default(now())
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  resident         Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  sourceCall       Call?    @relation(fields: [sourceCallId], references: [id])

  @@unique([residentId, category, key])
  @@index([residentId, isActive])
}

model StorySegment {
  id                 String           @id @default(uuid())
  callId             String
  residentId         String
  startTimeMs        Int
  endTimeMs          Int
  transcriptText     String
  speaker            String
  audioClipUrl       String?
  audioClipStatus    String           @default("pending")
  category           String?
  subcategory        String?
  entities           Json?
  storyQualityScore  Int?
  emotionalIntensity Float?
  isCompleteStory    Boolean          @default(false)
  isStarred          Boolean          @default(false)
  isExcluded         Boolean          @default(false)
  staffNotes         String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  emotionalTone      String?
  keyDates           Json?
  keyObjects         Json?
  keyPeople          Json?
  keyPlaces          Json?
  pullQuotes         Json?
  qualityRationale   String?
  sensitivityFlags   Json?
  lifeStoryEntries   LifeStoryEntry[]
  call               Call             @relation(fields: [callId], references: [id], onDelete: Cascade)
  resident           Resident         @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([residentId, category])
  @@index([callId])
  @@index([storyQualityScore])
}

model LifeStoryBook {
  id            String             @id @default(uuid())
  residentId    String             @unique
  status        String             @default("collecting")
  title         String?
  coverImageUrl String?
  tier          String?
  price         Float?
  familyName    String?
  familyEmail   String?
  familyPhone   String?
  purchasedAt   DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  assemblyData  Json?
  contentData   Json?
  reviewNotes   String?
  reviewStatus  String?
  reviewedAt    DateTime?
  reviewedBy    String?
  reviews       BookReview[]
  resident      Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  chapters      LifeStoryChapter[]
}

model BookReview {
  id                     String        @id @default(uuid())
  bookId                 String
  reviewerName           String
  reviewDate             DateTime      @default(now())
  transcriptsAccurate    Boolean       @default(false)
  pullQuotesVerbatim     Boolean       @default(false)
  chapterAssignments     Boolean       @default(false)
  storySequence          Boolean       @default(false)
  noRedundancy           Boolean       @default(false)
  sensitivityAddressed   Boolean       @default(false)
  chapter5Confirmed      Boolean       @default(false)
  tierAppropriate        Boolean       @default(false)
  pageAllocationBalanced Boolean       @default(false)
  noThinChapters         Boolean       @default(false)
  chapter5Present        Boolean       @default(false)
  framingWarm            Boolean       @default(false)
  noCliches              Boolean       @default(false)
  voicePreserved         Boolean       @default(false)
  titlesEvocative        Boolean       @default(false)
  audioAccessible        Boolean       @default(false)
  qrCodesGenerate        Boolean       @default(false)
  decision               String
  notes                  String?
  createdAt              DateTime      @default(now())
  book                   LifeStoryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
}

model LifeStoryChapter {
  id          String           @id @default(uuid())
  bookId      String
  title       String
  orderIndex  Int
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  book        LifeStoryBook    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  entries     LifeStoryEntry[]

  @@index([bookId, orderIndex])
}

model LifeStoryEntry {
  id               String           @id @default(uuid())
  chapterId        String
  segmentId        String
  title            String
  orderIndex       Int
  customTranscript String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  chapter          LifeStoryChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  segment          StorySegment     @relation(fields: [segmentId], references: [id])

  @@index([chapterId, orderIndex])
}

model FamilyMember {
  id                 String          @id @default(uuid())
  residentId         String
  firstName          String
  lastName           String
  relationship       String
  phoneNumber        String          @unique
  email              String?
  canReceiveCheckIns Boolean         @default(false)
  canAccessStarred   Boolean         @default(false)
  phoneVerified      Boolean         @default(false)
  phoneVerifiedAt    DateTime?
  verificationCode   String?
  verificationExpiry DateTime?
  notes              String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  checkIns           FamilyCheckIn[]
  resident           Resident        @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([residentId])
  @@index([phoneNumber])
}

model FamilyCheckIn {
  id               String       @id @default(uuid())
  familyMemberId   String
  residentId       String
  retellCallId     String?      @unique
  status           String       @default("pending")
  startedAt        DateTime?
  endedAt          DateTime?
  durationSeconds  Int?
  periodStartDate  DateTime?
  periodEndDate    DateTime?
  moodSummary      String?
  topicsDiscussed  Json?
  concernsRaised   Json?
  starredMoments   Json?
  generatedScript  String?
  generatedAt      DateTime?
  generationModel  String?
  generationTokens Int?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  callsCovered     Int?
  familyMember     FamilyMember @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)
  resident         Resident     @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([familyMemberId])
  @@index([residentId])
  @@index([retellCallId])
}

// =============================================================================
// MEMORY LAYER - Phase 1 Implementation
// =============================================================================

model CallState {
  id                      String   @id @default(uuid())
  callId                  String   @unique
  residentId              String
  recordedAt              DateTime @default(now())
  energyLevel             String?  // 'high' | 'medium' | 'low'
  emotionalTone           String?  // 'bright' | 'neutral' | 'melancholy' | 'anxious' | 'irritable'
  receptiveness           String?  // 'very_open' | 'open' | 'guarded' | 'tired' | 'resistant'
  warmupObserved          Boolean  @default(false)
  warmupDurationMinutes   Int?
  respondedWellTo         Json     @default("[]") // Array of approaches that worked
  didntLand               Json     @default("[]") // Array of approaches that didn't work
  topicsEngaged           Json     @default("[]") // Array of topics that sparked engagement
  topicsAvoided           Json     @default("[]") // Array of topics deflected
  emotionalPeaks          Json     @default("[]") // Array of {type, context}
  contextualFactors       Json     @default("[]") // Array of context strings
  notes                   String?
  createdAt               DateTime @default(now())
  call                    Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
  resident                Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([residentId, recordedAt])
}

model ResidentPattern {
  id                       String   @id @default(uuid())
  residentId               String   @unique
  typicalEnergy            String?  // 'high' | 'medium' | 'low'
  typicalTone              String?  // 'bright' | 'neutral' | 'melancholy'
  typicalReceptiveness     String?  // 'very_open' | 'open' | 'guarded'
  usuallyNeedsWarmup       Boolean  @default(false)
  typicalWarmupMinutes     Int?
  warmupNotes              String?
  approachesThatWork       Json     @default("[]") // Array of approach strings
  approachesToAvoid        Json     @default("[]") // Array of approach strings
  favoriteTopics           Json     @default("[]") // Array of topic strings
  sensitiveTopics          Json     @default("[]") // Array of topic strings
  temporalPatterns         Json     @default("[]") // Array of {pattern, description}
  keyPeople                Json     @default("[]") // Array of {name, relationship, notes}
  conversationalPreferences Json    @default("{}") // Object with pace, depth, humour, etc.
  personalitySummary       String?  // Free-form summary for prompt
  callsAnalyzed            Int      @default(0)
  updatedAt                DateTime @updatedAt
  createdAt                DateTime @default(now())
  resident                 Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)

  @@index([residentId])
}

model AnticipatedEvent {
  id                String    @id @default(uuid())
  residentId        String
  sourceCallId      String?
  eventType         String    // 'visit' | 'appointment' | 'birthday' | 'anniversary' | 'holiday' | 'other'
  description       String
  eventDate         DateTime?
  recurring         String?   // 'weekly' | 'monthly' | 'yearly'
  recurringDetails  Json?     // e.g., {day_of_week: 'Sunday'}
  emotionalTone     String?   // 'positive' | 'negative' | 'anxious' | 'neutral'
  shouldAskAbout    Boolean   @default(true)
  askedAbout        Boolean   @default(false)
  status            String    @default("upcoming") // 'upcoming' | 'passed' | 'cancelled'
  outcomeNotes      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  resident          Resident  @relation(fields: [residentId], references: [id], onDelete: Cascade)
  sourceCall        Call?     @relation(fields: [sourceCallId], references: [id])

  @@index([residentId, status])
  @@index([eventDate])
}

model Callback {
  id            String    @id @default(uuid())
  residentId    String
  sourceCallId  String?
  callbackType  String    // 'joke' | 'phrase' | 'story' | 'preference' | 'tease'
  content       String    // The joke/phrase/reference itself
  context       String?   // How it came up
  usageNotes    String?   // When/how Linda might use this
  timesUsed     Int       @default(0)
  lastUsed      DateTime?
  stillLands    Boolean   @default(true) // Does this still get a reaction?
  createdAt     DateTime  @default(now())
  resident      Resident  @relation(fields: [residentId], references: [id], onDelete: Cascade)
  sourceCall    Call?     @relation(fields: [sourceCallId], references: [id])

  @@index([residentId, stillLands])
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum CallDirection {
  INBOUND
  OUTBOUND
}
