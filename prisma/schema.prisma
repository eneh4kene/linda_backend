generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Facility {
  id        String     @id @default(uuid())
  name      String
  phone     String?
  timezone  String     @default("Europe/London")
  settings  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  residents Resident[]
}

model Resident {
  id                   String         @id @default(uuid())
  facilityId           String
  firstName            String
  lastName             String?
  preferredName        String?
  phoneNumber          String?
  roomNumber           String?
  status               String         @default("active")
  callConsent          Boolean        @default(false)
  callConsentDate      DateTime?
  lifestoryConsent     Boolean        @default(false)
  lifestoryConsentDate DateTime?
  preferredCallTimes   Json?
  communicationNotes   String?
  favoriteTopics       String?
  avoidTopics          String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  calls                Call[]
  memories             Memory[]
  facility             Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  segments             StorySegment[]
  lifeStoryBook        LifeStoryBook?

  @@index([facilityId, status])
}

model Call {
  id              String         @id @default(uuid())
  residentId      String
  retellCallId    String?        @unique
  callNumber      Int
  status          String         @default("scheduled")
  isFirstCall     Boolean        @default(false)
  scheduledAt     DateTime?
  startedAt       DateTime?
  endedAt         DateTime?
  durationSeconds Int?
  audioUrl        String?
  audioDurationMs Int?
  transcript      Json?
  transcriptText  String?
  summary         String?
  sentimentScore  Float?
  topicsDiscussed Json?          @default("[]")
  contextUsed     Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  direction       CallDirection  @default(OUTBOUND)
  resident        Resident       @relation(fields: [residentId], references: [id], onDelete: Cascade)
  memories        Memory[]
  segments        StorySegment[]

  @@index([residentId, status])
  @@index([retellCallId])
}

model Memory {
  id               String   @id @default(uuid())
  residentId       String
  sourceCallId     String?
  category         String
  key              String
  value            String
  confidence       Float    @default(0.8)
  timesMentioned   Int      @default(1)
  firstMentionedAt DateTime @default(now())
  lastMentionedAt  DateTime @default(now())
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  resident         Resident @relation(fields: [residentId], references: [id], onDelete: Cascade)
  sourceCall       Call?    @relation(fields: [sourceCallId], references: [id])

  @@unique([residentId, category, key])
  @@index([residentId, isActive])
}

model StorySegment {
  id                 String            @id @default(uuid())
  callId             String
  residentId         String
  startTimeMs        Int
  endTimeMs          Int
  transcriptText     String
  speaker            String
  audioClipUrl       String?
  audioClipStatus    String            @default("pending")
  category           String?
  subcategory        String?
  entities           Json?
  storyQualityScore  Int?              // Changed from Float to Int (1-5 scale)
  qualityRationale   String?           // Why this score was assigned
  emotionalIntensity Float?
  emotionalTone      String?
  isCompleteStory    Boolean           @default(false)
  isStarred          Boolean           @default(false)
  isExcluded         Boolean           @default(false)
  staffNotes         String?
  // Pull quotes (1-2 per segment)
  pullQuotes         Json?             // Array of {quote: string, rationale: string, rank: number}
  // Sensitivity flags for human review
  sensitivityFlags   Json?             // Array of flag types
  // Key details extraction
  keyPeople          Json?             // Array of person names mentioned
  keyPlaces          Json?             // Array of places mentioned
  keyDates           Json?             // Array of dates mentioned
  keyObjects         Json?             // Array of significant objects mentioned
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  call               Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  resident           Resident          @relation(fields: [residentId], references: [id], onDelete: Cascade)
  lifeStoryEntries   LifeStoryEntry[]

  @@index([residentId, category])
  @@index([callId])
  @@index([storyQualityScore])
}

model LifeStoryBook {
  id            String             @id @default(uuid())
  residentId    String             @unique
  status        String             @default("collecting") // collecting, ready_for_review, in_review, approved, in_production, delivered
  title         String?
  coverImageUrl String?
  tier          String?            // minimal, thin, standard, full
  price         Float?
  familyName    String?
  familyEmail   String?
  familyPhone   String?
  purchasedAt   DateTime?
  deliveredAt   DateTime?
  // Book assembly and content (Stage 3 & 4 output)
  assemblyData  Json?              // BookAssembly structure
  contentData   Json?              // GeneratedBookContent structure
  // Review tracking (Stage 5)
  reviewStatus  String?            // pending, approved, needs_revision, escalated
  reviewedBy    String?            // Reviewer name/ID
  reviewedAt    DateTime?
  reviewNotes   String?            // Review feedback
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  resident      Resident           @relation(fields: [residentId], references: [id], onDelete: Cascade)
  chapters      LifeStoryChapter[]
  reviews       BookReview[]
}

model BookReview {
  id                    String        @id @default(uuid())
  bookId                String
  reviewerName          String
  reviewDate            DateTime      @default(now())
  // Content checks
  transcriptsAccurate   Boolean       @default(false)
  pullQuotesVerbatim    Boolean       @default(false)
  chapterAssignments    Boolean       @default(false)
  storySequence         Boolean       @default(false)
  noRedundancy          Boolean       @default(false)
  // Sensitivity checks
  sensitivityAddressed  Boolean       @default(false)
  chapter5Confirmed     Boolean       @default(false)
  // Quality checks
  tierAppropriate       Boolean       @default(false)
  pageAllocationBalanced Boolean      @default(false)
  noThinChapters        Boolean       @default(false)
  chapter5Present       Boolean       @default(false)
  // Tone checks
  framingWarm           Boolean       @default(false)
  noCliches             Boolean       @default(false)
  voicePreserved        Boolean       @default(false)
  titlesEvocative       Boolean       @default(false)
  // Technical checks
  audioAccessible       Boolean       @default(false)
  qrCodesGenerate       Boolean       @default(false)
  // Final decision
  decision              String        // approved, needs_revision, escalate
  notes                 String?
  createdAt             DateTime      @default(now())
  book                  LifeStoryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
}

model LifeStoryChapter {
  id          String           @id @default(uuid())
  bookId      String
  title       String
  orderIndex  Int
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  book        LifeStoryBook    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  entries     LifeStoryEntry[]

  @@index([bookId, orderIndex])
}

model LifeStoryEntry {
  id               String           @id @default(uuid())
  chapterId        String
  segmentId        String
  title            String
  orderIndex       Int
  customTranscript String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  chapter          LifeStoryChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  segment          StorySegment     @relation(fields: [segmentId], references: [id])

  @@index([chapterId, orderIndex])
}

enum CallDirection {
  INBOUND
  OUTBOUND
}
